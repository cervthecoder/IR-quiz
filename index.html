<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IR → Structure Quiz</title>
  <style>
    :root { color-scheme: light dark; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin:0; padding:0;
      background:#0b0d12; color:#e9eef7;
    }

    header{
      padding: 14px 14px 10px;
      background: linear-gradient(180deg, #12182a, #0b0d12);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    header h1{ margin:0 0 4px; font-size: 16px; font-weight: 750; letter-spacing: 0.2px; }
    header p{ margin:0; opacity:0.78; font-size: 12px; line-height:1.35; }

    .wrap{ padding: 12px; max-width: 1400px; margin: 0 auto; }

    .card{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.spread{ justify-content: space-between; }

    select, button{
      background: rgba(255,255,255,0.05);
      color: inherit;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    button{ cursor:pointer; }
    button:hover{ border-color: rgba(255,255,255,0.24); }
    button:disabled{ opacity:0.45; cursor:not-allowed; }

    .pill{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      white-space: nowrap;
    }

    .stat{ font-size: 13px; opacity: 0.9; display:flex; gap: 12px; align-items:center; flex-wrap:wrap; }
    .small{ font-size: 12px; opacity: 0.78; }

    /* Full-width spectrum */
    #spectrumWrap{
      margin-top: 10px;
      width: 100%;
      height: min(68vh, 560px);
    }
    #spectrum{
      width:100%; height:100%;
      background: rgba(0,0,0,0.20);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
    }

    /* Choices row below */
    .choicesRow{
      margin-top: 12px;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 8px;
      scroll-snap-type: x mandatory;
    }

    .choice{
      scroll-snap-align: start;
      flex: 0 0 auto;
      width: 260px;
      border-radius: 16px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      cursor: pointer;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .choice:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.22); }
    .choice .label{ font-size: 12px; opacity: 0.92; }
    .choice.correct{ border-color: rgba(69, 214, 144, 0.85); background: rgba(69,214,144,0.10); }
    .choice.wrong{ border-color: rgba(255, 89, 106, 0.85); background: rgba(255,89,106,0.10); }

    .hintBox{ margin-top: 10px; }
    .danger{ border-color: rgba(255, 186, 48, 0.45); background: rgba(255,186,48,0.07); }

    /* Phone tweaks */
    @media (max-width: 520px){
      header h1{ font-size: 15px; }
      select, button{ padding: 9px 10px; font-size: 13px; }
      .choice{ width: 230px; }
      #spectrumWrap{ height: min(62vh, 520px); }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="padding:0;">
      <h1>IR → Structure Quiz</h1>
      <p>Absorbance-style display (peaks up). X-axis shows wavenumber increasing to the left (4000 → 650). Uses PubChem depictions for structures.</p>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row spread" style="gap: 12px;">
        <div class="row">
          <span class="pill" id="modePill">Mode: hard</span>
          <span class="pill" id="classPill">Class: mixed</span>
          <span class="pill" id="libPill">Library: 0</span>
        </div>
        <div class="row">
          <button id="btnNew">New</button>
          <button id="btnHint">Hint</button>
          <button id="btnReveal" class="danger">Reveal</button>
        </div>
      </div>

      <div class="row" style="margin-top: 10px;">
        <label class="small" for="selClass">Class</label>
        <select id="selClass">
          <option value="mixed">mixed</option>
          <option value="aliphatic">aliphatic</option>
          <option value="aromatic">aromatic</option>
          <option value="alcohol">alcohol</option>
          <option value="ketone">ketone</option>
          <option value="aldehyde">aldehyde</option>
          <option value="nitrile">nitrile</option>
        </select>

        <label class="small" for="selMode">Difficulty</label>
        <select id="selMode">
          <option value="medium">medium</option>
          <option value="hard" selected>hard (very similar options)</option>
          <option value="insane">insane (same subgroup/isomers)</option>
        </select>

        <span class="small" id="status" style="margin-left:auto;">Pick the structure that matches the IR spectrum.</span>
      </div>

      <div id="spectrumWrap">
        <canvas id="spectrum"></canvas>
      </div>

      <div class="row spread" style="margin-top: 10px;">
        <div class="stat">
          <div>Score: <b id="score">0</b> / <b id="total">0</b></div>
          <div>Streak: <b id="streak">0</b></div>
        </div>
        <div class="small">Choices scroll horizontally (swipe on phone).</div>
      </div>

      <div class="choicesRow" id="choices"></div>

      <div class="hintBox small" id="hint" style="display:none;"></div>
    </section>
  </main>

  <!-- Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // ============================================================
    // Library generation (>=200 compounds)
    // ============================================================
    // NOTE: These are synthetic spectra built from group-frequency templates + fingerprint noise.
    // Structures are fetched as PNG depictions from PubChem by name.

    const TEMPLATES = {
      aliphatic_alkane: {
        class: 'aliphatic',
        peaks: [
          { wn: 2960, intensity: 0.55, width: 22 },
          { wn: 2930, intensity: 0.70, width: 22 },
          { wn: 2870, intensity: 0.45, width: 24 },
          { wn: 1465, intensity: 0.38, width: 18 },
          { wn: 1375, intensity: 0.30, width: 16 },
          { wn: 720,  intensity: 0.40, width: 18 },
        ],
        hints: ['sp3 C–H stretches 3000–2850', 'No strong heteroatom bands', 'CH2 rock ~720 (if long chain)'],
      },
      aromatic_hydrocarbon: {
        class: 'aromatic',
        peaks: [
          { wn: 3030, intensity: 0.32, width: 20 },
          { wn: 1600, intensity: 0.52, width: 20 },
          { wn: 1495, intensity: 0.44, width: 18 },
          { wn: 1450, intensity: 0.22, width: 16 },
          { wn: 760,  intensity: 0.48, width: 18 },
          { wn: 700,  intensity: 0.44, width: 18 },
        ],
        hints: ['Aromatic C–H ~3030', 'Ring C=C ~1600/1500', 'Out-of-plane C–H 700–900'],
      },
      alcohol_primary: {
        class: 'alcohol',
        peaks: [
          { wn: 3350, intensity: 0.85, width: 160 },
          { wn: 2970, intensity: 0.38, width: 22 },
          { wn: 2930, intensity: 0.33, width: 22 },
          { wn: 1050, intensity: 0.70, width: 30 },
        ],
        hints: ['Broad O–H (3600–3200)', 'Strong C–O ~1050–1150', 'No carbonyl'],
      },
      alcohol_phenol: {
        class: 'alcohol',
        peaks: [
          { wn: 3350, intensity: 0.82, width: 170 },
          { wn: 3030, intensity: 0.28, width: 20 },
          { wn: 1600, intensity: 0.45, width: 20 },
          { wn: 1495, intensity: 0.35, width: 18 },
          { wn: 1210, intensity: 0.55, width: 26 },
          { wn: 750,  intensity: 0.40, width: 18 },
        ],
        hints: ['Broad O–H + aromatic bands', 'Ar–O stretch often ~1200–1260'],
      },
      ketone_aliphatic: {
        class: 'ketone',
        peaks: [
          { wn: 1715, intensity: 0.98, width: 22 },
          { wn: 2960, intensity: 0.45, width: 22 },
          { wn: 2870, intensity: 0.30, width: 22 },
          { wn: 1360, intensity: 0.30, width: 16 },
        ],
        hints: ['Very strong C=O ~1715', 'No aldehyde C–H doublet at ~2820/2720'],
      },
      ketone_aromatic: {
        class: 'ketone',
        peaks: [
          { wn: 1685, intensity: 0.95, width: 22 },
          { wn: 3030, intensity: 0.30, width: 20 },
          { wn: 1600, intensity: 0.45, width: 20 },
          { wn: 1495, intensity: 0.35, width: 18 },
          { wn: 760,  intensity: 0.40, width: 18 },
        ],
        hints: ['Conjugated/aromatic ketone C=O can shift lower (~1685–1700)'],
      },
      aldehyde_aliphatic: {
        class: 'aldehyde',
        peaks: [
          { wn: 1725, intensity: 0.95, width: 22 },
          { wn: 2820, intensity: 0.32, width: 18 },
          { wn: 2720, intensity: 0.30, width: 18 },
          { wn: 2960, intensity: 0.40, width: 22 },
        ],
        hints: ['Aldehyde C–H doublet (~2820 & ~2720)', 'Strong C=O'],
      },
      aldehyde_aromatic: {
        class: 'aldehyde',
        peaks: [
          { wn: 1700, intensity: 0.92, width: 22 },
          { wn: 2820, intensity: 0.28, width: 18 },
          { wn: 2720, intensity: 0.26, width: 18 },
          { wn: 3030, intensity: 0.30, width: 20 },
          { wn: 1600, intensity: 0.46, width: 20 },
          { wn: 1495, intensity: 0.36, width: 18 },
        ],
        hints: ['Aldehyde doublet + aromatic ring signals'],
      },
      nitrile_aliphatic: {
        class: 'nitrile',
        peaks: [
          { wn: 2250, intensity: 0.75, width: 16 },
          { wn: 2960, intensity: 0.35, width: 22 },
          { wn: 2870, intensity: 0.25, width: 22 },
        ],
        hints: ['Sharp C≡N (~2260–2220)', 'No carbonyl'],
      },
      nitrile_aromatic: {
        class: 'nitrile',
        peaks: [
          { wn: 2230, intensity: 0.75, width: 16 },
          { wn: 3030, intensity: 0.30, width: 20 },
          { wn: 1600, intensity: 0.46, width: 20 },
          { wn: 1495, intensity: 0.36, width: 18 },
          { wn: 760,  intensity: 0.40, width: 18 },
        ],
        hints: ['Aromatic pattern + nitrile band'],
      },
    };

    // 200+ compound names (common/simple names so PubChem can depict them)
    // We keep them grouped so distractors can be very similar.
    const NAME_BANK = {
      aliphatic_alkane: [
        'Methane','Ethane','Propane','Butane','Isobutane','Pentane','Isopentane','Neopentane',
        'Hexane','Heptane','Octane','Nonane','Decane','Undecane','Dodecane','Tridecane','Tetradecane','Pentadecane','Hexadecane',
        'Cyclopentane','Cyclohexane','Cycloheptane','Cyclooctane','Methylcyclohexane','Ethylcyclohexane','tert-Butylcyclohexane',
        '2-Methylpentane','3-Methylpentane','2,2-Dimethylbutane','2,3-Dimethylbutane','2-Methylhexane','3-Methylhexane','2,2-Dimethylpentane','2,3-Dimethylpentane','2,4-Dimethylpentane','3,3-Dimethylpentane',
        '2-Methylheptane','3-Methylheptane','4-Methylheptane','2,2,4-Trimethylpentane','2,3,4-Trimethylpentane','2,2,3-Trimethylbutane',
      ],
      aromatic_hydrocarbon: [
        'Benzene','Toluene','Ethylbenzene','Propylbenzene','Isopropylbenzene','sec-Butylbenzene','tert-Butylbenzene','Cumene',
        'o-Xylene','m-Xylene','p-Xylene','Mesitylene','Durene','Styrene','Alpha-methylstyrene','Indane','Tetralin','Biphenyl','Naphthalene','Anthracene','Phenanthrene',
        'Chlorobenzene','Bromobenzene','Iodobenzene','Fluorobenzene','o-Dichlorobenzene','m-Dichlorobenzene','p-Dichlorobenzene',
        'Anisole','Phenetole','Diphenylmethane','Triphenylmethane','Acenaphthene','Fluorene','Phenylacetylene'
      ],
      alcohol_primary: [
        'Methanol','Ethanol','1-Propanol','2-Propanol','1-Butanol','2-Butanol','tert-Butanol','Isobutanol','Neopentyl alcohol',
        '1-Pentanol','2-Pentanol','3-Pentanol','1-Hexanol','2-Hexanol','3-Hexanol','1-Heptanol','1-Octanol','2-Octanol','1-Nonanol','1-Decanol',
        'Ethylene glycol','1,2-Propanediol','1,3-Propanediol','1,4-Butanediol','1,2-Butanediol','Glycerol','2-Methyl-1-propanol','2-Methyl-2-propanol'
      ],
      alcohol_phenol: [
        'Phenol','o-Cresol','m-Cresol','p-Cresol','Catechol','Resorcinol','Hydroquinone','Benzyl alcohol','2-Phenylethanol','4-Methylbenzyl alcohol',
        '4-Chlorophenol','4-Bromophenol','2-Chlorophenol','2-Naphthol','1-Naphthol','Vanillyl alcohol','Tyrosol'
      ],
      ketone_aliphatic: [
        'Acetone','2-Butanone','3-Pentanone','2-Pentanone','2-Hexanone','3-Hexanone','4-Heptanone','2-Heptanone','2-Octanone','3-Octanone','4-Nonanone',
        'Cyclopentanone','Cyclohexanone','Cycloheptanone','Cyclooctanone','Methyl ethyl ketone','Diisopropyl ketone','Pinacolone','Acetylacetone'
      ],
      ketone_aromatic: [
        'Acetophenone','Propiophenone','Butyrophenone','Benzophenone','4-Methylacetophenone','4-Methoxyacetophenone','4-Chloroacetophenone','2-Methylacetophenone',
        '2-Chloroacetophenone','4-Fluoroacetophenone','2,4-Dimethylacetophenone','1-Acetonaphthone','2-Acetonaphthone'
      ],
      aldehyde_aliphatic: [
        'Formaldehyde','Acetaldehyde','Propanal','Butanal','Pentanal','Hexanal','Heptanal','Octanal','Nonanal','Decanal',
        'Isobutyraldehyde','Isovaleraldehyde','2-Methylbutanal','3-Methylbutanal','2-Ethylbutanal'
      ],
      aldehyde_aromatic: [
        'Benzaldehyde','o-Tolualdehyde','m-Tolualdehyde','p-Tolualdehyde','Anisaldehyde','4-Chlorobenzaldehyde','4-Bromobenzaldehyde','2-Chlorobenzaldehyde',
        '3-Chlorobenzaldehyde','2,4-Dichlorobenzaldehyde','Vanillin','Cinnamaldehyde','Salicylaldehyde','Piperonal','2-Naphthaldehyde','1-Naphthaldehyde'
      ],
      nitrile_aliphatic: [
        'Acetonitrile','Propionitrile','Butyronitrile','Valeronitrile','Hexanenitrile','Heptanenitrile','Octanenitrile','Nonanenitrile','Decanenitrile',
        'Isobutyronitrile','Isovaleronitrile','2-Methylbutanenitrile','3-Methylbutanenitrile','Succinonitrile','Glutaronitrile','Adiponitrile'
      ],
      nitrile_aromatic: [
        'Benzonitrile','o-Tolunitrile','m-Tolunitrile','p-Tolunitrile','4-Chlorobenzonitrile','4-Bromobenzonitrile','2-Chlorobenzonitrile','3-Chlorobenzonitrile',
        '2,4-Dichlorobenzonitrile','4-Fluorobenzonitrile','1-Naphthonitrile','2-Naphthonitrile','4-Methoxybenzonitrile'
      ],
    };

    // Expand to >= 200 by programmatic augmentation where needed
    // (e.g., add numbered alkylbenzenes / alkyl nitriles / alcohols etc.)
    function augmentBank() {
      // Add alkylbenzenes C1–C12 (common names are messy; we use "<n>-Propylbenzene" etc. which PubChem usually understands)
      const alkyls = ['Methyl','Ethyl','Propyl','Butyl','Pentyl','Hexyl','Heptyl','Octyl','Nonyl','Decyl'];
      for (const a of alkyls) {
        NAME_BANK.aromatic_hydrocarbon.push(`${a}benzene`);
      }
      // Add straight-chain alcohols 11–20
      for (let n = 11; n <= 20; n++) NAME_BANK.alcohol_primary.push(`${n}-Decanol`.replace('11-Decanol','Undecanol').replace('12-Decanol','Dodecanol'));
      // Add nitriles 11–16 (generic names)
      const extraNitriles = ['Undecanenitrile','Dodecanenitrile','Tridecanenitrile','Tetradecanenitrile','Pentadecanenitrile','Hexadecanenitrile'];
      NAME_BANK.nitrile_aliphatic.push(...extraNitriles);
      // Add aldehydes 11–16
      const extraAld = ['Undecanal','Dodecanal','Tridecanal','Tetradecanal','Pentadecanal','Hexadecanal'];
      NAME_BANK.aldehyde_aliphatic.push(...extraAld);
      // Add ketones: 2-alkanones 9–14
      const extraKet = ['2-Nonanone','2-Decanone','2-Undecanone','2-Dodecanone','2-Tridecanone','2-Tetradecanone'];
      NAME_BANK.ketone_aliphatic.push(...extraKet);
    }
    augmentBank();

    function mulberry32(seed) {
      return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    function hashString(s) {
      let h = 2166136261;
      for (let i = 0; i < s.length; i++) {
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function jitterPeaks(peaks, rng) {
      // create a slightly varied copy of template peaks so "similar" compounds remain similar
      const out = peaks.map(p => ({...p}));
      for (const p of out) {
        const shift = (rng() - 0.5) * 12; // +/-6 cm-1
        const inten = 1 + (rng() - 0.5) * 0.18;
        const wid = 1 + (rng() - 0.5) * 0.14;
        p.wn = p.wn + shift;
        p.intensity = Math.max(0.06, Math.min(1.0, p.intensity * inten));
        p.width = Math.max(10, p.width * wid);
      }
      return out;
    }

    function addFingerprintNoise(peaks, rng, strength=0.18) {
      // add a few small-ish peaks in fingerprint region to make things look real
      const n = 8 + Math.floor(rng() * 8);
      for (let i = 0; i < n; i++) {
        const wn = 650 + rng() * (1800 - 650);
        const intensity = strength * (0.25 + rng() * 0.75);
        const width = 10 + rng() * 26;
        peaks.push({ wn, intensity, width });
      }
      return peaks;
    }

    function buildLibrary() {
      const lib = [];
      const seen = new Set();
      for (const [templateKey, names] of Object.entries(NAME_BANK)) {
        const tpl = TEMPLATES[templateKey];
        if (!tpl) continue;
        for (const name of names) {
          const id = `${templateKey}__${name}`.toLowerCase().replace(/[^a-z0-9]+/g,'_');
          if (seen.has(id)) continue;
          seen.add(id);
          const rng = mulberry32(hashString(id));
          let peaks = jitterPeaks(tpl.peaks, rng);
          peaks = addFingerprintNoise(peaks, rng, 0.14);
          lib.push({
            id,
            name,
            class: tpl.class,
            subgroup: templateKey,
            peaks,
            hints: tpl.hints,
          });
        }
      }
      return lib;
    }

    const COMPOUNDS = buildLibrary();

    // ============================================================
    // Spectrum generator: synthetic transmittance -> convert to absorbance-like (peaks up)
    // ============================================================
    function gaussian(x, mu, sigma) {
      const z = (x - mu) / sigma;
      return Math.exp(-0.5 * z * z);
    }

    function makeSpectrumFromPeaks(peaks, opts) {
      const wnMin = 650;
      const wnMax = 4000;
      const step = opts.step ?? 2;
      const noise = opts.noise ?? 0.004;
      const baseline = opts.baseline ?? 0.94; // transmittance baseline

      const xs = [];
      const ysAbs = [];

      // Generate %T trace
      for (let wn = wnMax; wn >= wnMin; wn -= step) {
        let absorb = 0;
        for (const p of peaks) {
          const sigma = (p.width ?? 20);
          absorb += (p.intensity ?? 0.5) * gaussian(wn, p.wn, sigma);
        }
        let t = baseline - 0.55 * absorb;
        t += 0.01 * Math.sin(wn / 180) + 0.006 * Math.sin(wn / 57);
        t += (Math.random() - 0.5) * 2 * noise;
        t = Math.max(0.02, Math.min(0.99, t));

        const percentT = t * 100;
        // Invert to absorbance-like so peaks go UP
        const a = 100 - percentT;

        xs.push(wn);
        ysAbs.push(a);
      }
      return { xs, ysAbs };
    }

    // ============================================================
    // PubChem depiction images for structures
    // ============================================================
    function depictionUrlFromPubChem(compound) {
      const size = 420;
      const name = encodeURIComponent(compound.name);
      return `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${name}/PNG?image_size=${size}x${size}`;
    }

    // ============================================================
    // Quiz engine
    // ============================================================
    const state = {
      mode: 'hard',
      classFilter: 'mixed',
      current: null,
      options: [],
      locked: false,
      score: 0,
      total: 0,
      streak: 0,
      chart: null,
      hintShown: 0,
    };

    function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function poolByFilter() {
      if (state.classFilter === 'mixed') return COMPOUNDS.slice();
      return COMPOUNDS.filter(c => c.class === state.classFilter);
    }

    function chooseDistractors(correct, pool) {
      const wanted = 3;
      let candidates = pool.filter(c => c.id !== correct.id);

      if (state.mode === 'medium') {
        // Prefer same class
        const same = candidates.filter(c => c.class === correct.class);
        const other = candidates.filter(c => c.class !== correct.class);
        candidates = (same.length >= wanted ? same : same.concat(other));
      }

      if (state.mode === 'hard') {
        // Prefer same subgroup (very similar IR), then same class
        const sameSub = candidates.filter(c => c.subgroup === correct.subgroup);
        const sameClass = candidates.filter(c => c.class === correct.class && c.subgroup !== correct.subgroup);
        const other = candidates.filter(c => c.class !== correct.class);
        candidates = sameSub.concat(sameClass).concat(other);
      }

      if (state.mode === 'insane') {
        // Only same subgroup if possible
        const sameSub = candidates.filter(c => c.subgroup === correct.subgroup);
        const fallback = candidates.filter(c => c.class === correct.class);
        candidates = (sameSub.length >= wanted ? sameSub : sameSub.concat(fallback));
      }

      return shuffle(candidates).slice(0, wanted);
    }

    function setStatus(msg) { document.getElementById('status').textContent = msg; }
    function renderStats() {
      document.getElementById('score').textContent = String(state.score);
      document.getElementById('total').textContent = String(state.total);
      document.getElementById('streak').textContent = String(state.streak);
    }
    function renderPills() {
      document.getElementById('modePill').textContent = `Mode: ${state.mode}`;
      document.getElementById('classPill').textContent = `Class: ${state.classFilter}`;
      document.getElementById('libPill').textContent = `Library: ${COMPOUNDS.length}`;
    }

    function renderSpectrum(compound) {
      const spectrum = makeSpectrumFromPeaks(compound.peaks, {
        step: 2,
        noise: state.mode === 'medium' ? 0.006 : 0.008,
        baseline: state.mode === 'medium' ? 0.95 : 0.93,
      });

      const ctx = document.getElementById('spectrum');
      const data = {
        labels: spectrum.xs,
        datasets: [{
          label: 'Absorbance (a.u.)',
          data: spectrum.ysAbs,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.12,
        }]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => `Wavenumber: ${items?.[0]?.label} cm⁻¹`,
              label: (item) => `Abs: ${Number(item.parsed.y).toFixed(1)}`
            }
          }
        },
        scales: {
          x: {
            // Wavenumber increasing to the left -> reverse axis (4000 at left)
            reverse: true,
            title: { display: true, text: 'Wavenumber (cm⁻¹)' },
            ticks: { maxTicksLimit: 10 }
          },
          y: {
            min: 0,
            max: 100,
            title: { display: true, text: 'Absorbance (100 − %T)' },
            ticks: { maxTicksLimit: 6 }
          }
        }
      };

      if (state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, { type: 'line', data, options });
    }

    function clearChoices() { document.getElementById('choices').innerHTML = ''; }

    function makeChoiceCard(compound, idx) {
      const div = document.createElement('div');
      div.className = 'choice';
      div.dataset.id = compound.id;

      const imgUrl = depictionUrlFromPubChem(compound);

      div.innerHTML = `
        <div class="label"><b>${String.fromCharCode(65 + idx)}</b> — ${compound.name}</div>
        <div style="border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); padding: 10px; display:flex; align-items:center; justify-content:center; min-height: 92px;">
          <img
            alt="${compound.name} structure"
            src="${imgUrl}"
            referrerpolicy="no-referrer"
            loading="lazy"
            style="max-width: 100%; max-height: 130px; object-fit: contain;"
            onerror="this.style.display='none'; this.parentElement.innerHTML = '<div class=small style=opacity:.8>Could not load depiction.<br/>Try another name or add PubChem CID support.</div>'"
          />
        </div>
        <div class="small"><span class="pill">${compound.class}</span> <span class="pill">${compound.subgroup.replace(/_/g,' ')}</span></div>
      `;

      div.addEventListener('click', () => handleAnswer(compound.id));
      return div;
    }

    function lockChoices(lock) { state.locked = lock; }

    function markChoices(correctId, pickedId) {
      const nodes = Array.from(document.querySelectorAll('.choice'));
      for (const n of nodes) {
        const id = n.dataset.id;
        n.classList.remove('correct', 'wrong');
        if (id === correctId) n.classList.add('correct');
        if (pickedId && id === pickedId && pickedId !== correctId) n.classList.add('wrong');
      }
    }

    function showHint() {
      if (!state.current) return;
      const el = document.getElementById('hint');
      el.style.display = 'block';

      const hints = state.current.hints ?? [];
      if (!hints.length) {
        el.textContent = 'No hints for this item.';
        return;
      }

      // progressive reveal: 1st click shows 1, then 2, etc.
      state.hintShown = Math.min(hints.length, state.hintShown + 1);
      const shown = hints.slice(0, state.hintShown);
      el.innerHTML = `<b>Hint:</b> ${shown.map(h => `• ${h}`).join(' &nbsp; ')}`;
    }

    async function newQuestion() {
      lockChoices(false);
      state.hintShown = 0;
      document.getElementById('hint').style.display = 'none';
      setStatus('Pick the structure that matches the IR spectrum.');

      const pool = poolByFilter();
      if (pool.length < 4) {
        setStatus('Not enough compounds in this class filter (need at least 4).');
        return;
      }

      const correct = pickRandom(pool);
      const distractors = chooseDistractors(correct, pool);
      const options = shuffle([correct, ...distractors]);

      state.current = correct;
      state.options = options;

      renderSpectrum(correct);
      clearChoices();

      const choicesEl = document.getElementById('choices');
      options.forEach((c, idx) => choicesEl.appendChild(makeChoiceCard(c, idx)));

      renderPills();
      renderStats();
    }

    function handleAnswer(chosenId) {
      if (state.locked || !state.current) return;
      lockChoices(true);

      const correctId = state.current.id;
      const ok = chosenId === correctId;
      state.total += 1;

      if (ok) {
        state.score += 1;
        state.streak += 1;
        setStatus(`✅ Correct: ${state.current.name} (${state.current.class})`);
      } else {
        state.streak = 0;
        const chosen = state.options.find(o => o.id === chosenId);
        setStatus(`❌ Not quite. Correct: ${state.current.name}. You picked: ${chosen?.name ?? 'unknown'}.`);
      }

      markChoices(correctId, chosenId);
      renderStats();

      // After answering, show all hints automatically
      const el = document.getElementById('hint');
      const hints = state.current.hints ?? [];
      if (hints.length) {
        el.style.display = 'block';
        el.innerHTML = `<b>Hints:</b> ${hints.map(h => `• ${h}`).join(' &nbsp; ')}`;
      }
    }

    function reveal() {
      if (!state.current) return;
      lockChoices(true);
      markChoices(state.current.id, null);
      setStatus(`Answer: ${state.current.name} (${state.current.class})`);
      const el = document.getElementById('hint');
      const hints = state.current.hints ?? [];
      el.style.display = hints.length ? 'block' : 'none';
      if (hints.length) el.innerHTML = `<b>Hints:</b> ${hints.map(h => `• ${h}`).join(' &nbsp; ')}`;
    }

    // UI wiring
    document.getElementById('btnNew').addEventListener('click', newQuestion);
    document.getElementById('btnReveal').addEventListener('click', reveal);
    document.getElementById('btnHint').addEventListener('click', showHint);

    document.getElementById('selMode').addEventListener('change', (e) => {
      state.mode = e.target.value;
      renderPills();
      newQuestion();
    });

    document.getElementById('selClass').addEventListener('change', (e) => {
      state.classFilter = e.target.value;
      renderPills();
      newQuestion();
    });

    // Bootstrap
    renderPills();
    newQuestion();
  </script>
</body>
</html>

